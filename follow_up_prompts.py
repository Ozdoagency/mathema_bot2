from datetime import datetime, timedelta

FOLLOW_UP_PROMPTS = {
    "15min": """{first_name}, Ð£ Ð½Ð°Ñ Ñ” Ñ‡ÑƒÐ´Ð¾Ð²Ð° Ð¼Ð¾Ð¶Ð»Ð¸Ð²Ñ–ÑÑ‚ÑŒ Ð¿Ð¾ÐºÑ€Ð°Ñ‰Ð¸Ñ‚Ð¸ Ð·Ð½Ð°Ð½Ð½Ñ Ð²Ð°ÑˆÐ¾Ñ— Ð´Ð¸Ñ‚Ð¸Ð½Ð¸ Ð· Ð¼Ð°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸ÐºÐ¸. Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ð¿Ñ–Ð´Ð±ÐµÑ€ÐµÐ¼Ð¾ Ð·Ñ€ÑƒÑ‡Ð½Ð¸Ð¹ Ñ‡Ð°Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð±Ð½Ð¾Ð³Ð¾ ÑƒÑ€Ð¾ÐºÑƒ, Ð¿Ñ–Ð´ÐºÐ°Ð¶Ñ–Ñ‚ÑŒ, ÐºÐ¾Ð»Ð¸ Ð²Ð°Ð¼ Ð±ÑƒÐ´Ðµ Ð·Ñ€ÑƒÑ‡Ð½Ð¾? Ð£ Ð½Ð°Ñ Ñ” ÑÐ»Ð¾Ñ‚Ð¸ Ð²Ñ€Ð°Ð½Ñ†Ñ–, Ð¾Ð±Ñ–Ð´ Ñ‚Ð° ÑƒÐ²ÐµÑ‡ÐµÑ€Ñ– ðŸŽ¯\n\nP.S. Ð”Ð¾ Ñ€ÐµÑ‡Ñ–, Ð·Ð°Ñ€Ð°Ð· Ñƒ Ð½Ð°Ñ Ñ” ÐºÑ–Ð»ÑŒÐºÐ° Ð²Ñ–Ð»ÑŒÐ½Ð¸Ñ… Ð¼Ñ–ÑÑ†ÑŒ Ñƒ Ð³Ñ€ÑƒÐ¿Ð°Ñ…, Ð´Ðµ Ð´Ñ–Ñ‚Ð¸ Ð²Ð¶Ðµ Ð¿Ð¾ÐºÐ°Ð·ÑƒÑŽÑ‚ÑŒ Ð³Ð°Ñ€Ð½Ñ– Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¸. Ð‘ÑƒÐ»Ð¾ Ð± Ñ‡ÑƒÐ´Ð¾Ð²Ð¾, ÑÐºÐ±Ð¸ Ð²Ð°ÑˆÐ° Ð´Ð¸Ñ‚Ð¸Ð½Ð° Ñ‚ÐµÐ¶ Ð´Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð°ÑÑ! ðŸ“š""",
    "2hours": """{first_name}, Ð¯ Ñ€Ð¾Ð·ÑƒÐ¼Ñ–ÑŽ, Ñ‰Ð¾ Ð²Ð¸Ð±Ñ–Ñ€ Ñ€ÐµÐ¿ÐµÑ‚Ð¸Ñ‚Ð¾Ñ€Ð° - Ñ†Ðµ Ð²Ð°Ð¶Ð»Ð¸Ð²Ðµ Ñ€Ñ–ÑˆÐµÐ½Ð½Ñ. ÐœÐ¾Ð¶Ð»Ð¸Ð²Ð¾, Ñƒ Ð²Ð°Ñ Ñ” Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ Ñ‰Ð¾Ð´Ð¾ Ð½Ð°ÑˆÐ¾Ñ— Ð¼ÐµÑ‚Ð¾Ð´Ð¸ÐºÐ¸ Ñ‡Ð¸ Ð²Ð¸ÐºÐ»Ð°Ð´Ð°Ñ‡Ñ–Ð²? \n\nÐœÐ¸ Ð¿Ð¸ÑˆÐ°Ñ”Ð¼Ð¾ÑÑ Ñ‚Ð¸Ð¼, Ñ‰Ð¾ 93% Ð½Ð°ÑˆÐ¸Ñ… ÑƒÑ‡Ð½Ñ–Ð² Ð¿Ð¾ÐºÑ€Ð°Ñ‰ÑƒÑŽÑ‚ÑŒ ÑÐ²Ð¾Ñ— Ð¾Ñ†Ñ–Ð½ÐºÐ¸ Ð²Ð¶Ðµ Ð·Ð° Ð¿ÐµÑ€ÑˆÐ¸Ð¹ Ð¼Ñ–ÑÑÑ†ÑŒ Ð·Ð°Ð½ÑÑ‚ÑŒ. Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ð¾Ð±Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ð¼Ð¾, ÑÐº Ð¼Ð¸ Ð¼Ð¾Ð¶ÐµÐ¼Ð¾ Ð´Ð¾Ð¿Ð¾Ð¼Ð¾Ð³Ñ‚Ð¸ Ð²Ð°ÑˆÑ–Ð¹ Ð´Ð¸Ñ‚Ð¸Ð½Ñ–? ðŸŒŸ""",
    "24hours": """{first_name}, Ð’Ñ–Ñ‚Ð°ÑŽ! Ð¥Ð¾Ñ‡Ñƒ Ð¿Ð¾Ð´Ñ–Ð»Ð¸Ñ‚Ð¸ÑÑ Ñ–ÑÑ‚Ð¾Ñ€Ñ–Ñ”ÑŽ ÑƒÑÐ¿Ñ–Ñ…Ñƒ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð· Ð½Ð°ÑˆÐ¸Ñ… ÑƒÑ‡Ð½Ñ–Ð², ÑÐºÐ¸Ð¹, ÑÐº Ñ– Ð²Ð°ÑˆÐ° Ð´Ð¸Ñ‚Ð¸Ð½Ð°, Ð¼Ð°Ð² ÑÐºÐ»Ð°Ð´Ð½Ð¾Ñ‰Ñ– Ð· Ð¼Ð°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸ÐºÐ¾ÑŽ. Ð—Ð° 2 Ð¼Ñ–ÑÑÑ†Ñ– Ð·Ð°Ð½ÑÑ‚ÑŒ Ð²Ñ–Ð½ Ð¿Ñ–Ð´Ð²Ð¸Ñ‰Ð¸Ð² ÑÐ²Ñ–Ð¹ Ñ€Ñ–Ð²ÐµÐ½ÑŒ Ð½Ð° 3 Ð±Ð°Ð»Ð¸!\n\nÐŸÑ€Ð¾Ð¿Ð¾Ð½ÑƒÑŽ 15-Ñ…Ð²Ð¸Ð»Ð¸Ð½Ð½Ñƒ ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ñ–ÑŽ, Ñ‰Ð¾Ð± Ñ€Ð¾Ð·Ð¿Ð¾Ð²Ñ–ÑÑ‚Ð¸, ÑÐº Ð¼Ð¸ Ð¼Ð¾Ð¶ÐµÐ¼Ð¾ Ð´Ð¾ÑÑÐ³Ñ‚Ð¸ Ñ‚Ð°ÐºÐ¸Ñ… Ð¶Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ–Ð² Ð· Ð²Ð°ÑˆÐ¾ÑŽ Ð´Ð¸Ñ‚Ð¸Ð½Ð¾ÑŽ. Ð¯ÐºÐ¸Ð¹ Ñ‡Ð°Ñ Ð²Ð°Ð¼ Ð·Ñ€ÑƒÑ‡Ð½Ð¸Ð¹? â­ï¸""",
    "48hours": """{first_name}, Ð”Ð¾Ð±Ñ€Ð¾Ð³Ð¾ Ð´Ð½Ñ! ÐœÐ¸ Ð¿Ñ–Ð´Ð³Ð¾Ñ‚ÑƒÐ²Ð°Ð»Ð¸ ÑÐ¿ÐµÑ†Ñ–Ð°Ð»ÑŒÐ½Ñƒ Ð¿Ñ€Ð¾Ð¿Ð¾Ð·Ð¸Ñ†Ñ–ÑŽ Ð´Ð»Ñ Ð½Ð¾Ð²Ð¸Ñ… ÑƒÑ‡Ð½Ñ–Ð²: Ð¿ÐµÑ€ÑˆÐ¸Ð¹ Ñ‚Ð¸Ð¶Ð´ÐµÐ½ÑŒ Ð·Ð°Ð½ÑÑ‚ÑŒ Ð±ÐµÐ·ÐºÐ¾ÑˆÑ‚Ð¾Ð²Ð½Ð¾ + Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½Ð¸Ð¹ Ð¿Ð»Ð°Ð½ Ð½Ð°Ð²Ñ‡Ð°Ð½Ð½Ñ. \n\nÐ¦Ðµ Ñ‡ÑƒÐ´Ð¾Ð²Ð° Ð¼Ð¾Ð¶Ð»Ð¸Ð²Ñ–ÑÑ‚ÑŒ Ð¿Ð¾Ð±Ð°Ñ‡Ð¸Ñ‚Ð¸ Ð½Ð°ÑˆÑƒ Ð¼ÐµÑ‚Ð¾Ð´Ð¸ÐºÑƒ Ð² Ð´Ñ–Ñ— Ð±ÐµÐ· Ð¶Ð¾Ð´Ð½Ð¸Ñ… Ð·Ð¾Ð±Ð¾Ð²'ÑÐ·Ð°Ð½ÑŒ. ÐŸÑ€Ð¾Ð¿Ð¾Ð·Ð¸Ñ†Ñ–Ñ Ð´Ñ–Ð¹ÑÐ½Ð° Ð»Ð¸ÑˆÐµ Ñ†ÑŒÐ¾Ð³Ð¾ Ñ‚Ð¸Ð¶Ð½Ñ. Ð—Ð°Ñ†Ñ–ÐºÐ°Ð²Ð¸Ð»Ð¸ÑÑ? ðŸŽ“""",
    "72hours": """{first_name}, Ð’Ñ–Ñ‚Ð°ÑŽ! Ð¯Ðº Ð²Ð°ÑˆÑ– ÑÐ¿Ñ€Ð°Ð²Ð¸? Ð¯ Ð·Ð½Ð°ÑŽ, ÑÐº Ð²Ð°Ð¶Ð»Ð¸Ð²Ð¾ Ð·Ñ€Ð¾Ð±Ð¸Ñ‚Ð¸ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¸Ð¹ Ð²Ð¸Ð±Ñ–Ñ€ Ð´Ð»Ñ ÑÐ²Ð¾Ñ”Ñ— Ð´Ð¸Ñ‚Ð¸Ð½Ð¸. ÐœÐ¸ Ð² "ÐœÐ°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸Ðº ÐžÐ½Ð»Ð°Ð¹Ð½" Ð³Ð°Ñ€Ð°Ð½Ñ‚ÑƒÑ”Ð¼Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð²Ð¶Ðµ Ð·Ð° Ð¿ÐµÑ€ÑˆÐ¸Ð¹ Ð¼Ñ–ÑÑÑ†ÑŒ Ð·Ð°Ð½ÑÑ‚ÑŒ, Ð°Ð±Ð¾ Ð¿Ð¾Ð²ÐµÑ€Ð½ÐµÐ¼Ð¾ ÐºÐ¾ÑˆÑ‚Ð¸.\n\nÐœÐ¾Ð¶Ñƒ Ð·Ð°Ð¿Ñ€Ð¾Ð¿Ð¾Ð½ÑƒÐ²Ð°Ñ‚Ð¸ Ð²Ð°Ð¼ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½Ñƒ Ð·Ð½Ð¸Ð¶ÐºÑƒ 10% Ð½Ð° Ð¿ÐµÑ€ÑˆÐ¸Ð¹ Ð¼Ñ–ÑÑÑ†ÑŒ Ð½Ð°Ð²Ñ‡Ð°Ð½Ð½Ñ. Ð¥Ð¾Ñ‡ÐµÑ‚Ðµ Ð´Ñ–Ð·Ð½Ð°Ñ‚Ð¸ÑÑ Ð´ÐµÑ‚Ð°Ð»Ñ–? ðŸŒŸ\n\nP.S. ÐŸÑ€Ð¾Ð¿Ð¾Ð·Ð¸Ñ†Ñ–Ñ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð° Ð»Ð¸ÑˆÐµ ÑÑŒÐ¾Ð³Ð¾Ð´Ð½Ñ–."""
}

REMINDER_INTERVALS = {
    "15min": 15 * 60,        # 15 Ñ…Ð²Ð¸Ð»Ð¸Ð½ Ñƒ ÑÐµÐºÑƒÐ½Ð´Ð°Ñ…
    "2hours": 2 * 60 * 60,   # 2 Ð³Ð¾Ð´Ð¸Ð½Ð¸
    "24hours": 24 * 60 * 60, # 24 Ð³Ð¾Ð´Ð¸Ð½Ð¸
    "48hours": 48 * 60 * 60, # 48 Ð³Ð¾Ð´Ð¸Ð½
    "72hours": 72 * 60 * 60  # 72 Ð³Ð¾Ð´Ð¸Ð½Ð¸
}

def get_next_valid_time(current_time: datetime) -> datetime:
    """
    Ð’Ð¸Ð·Ð½Ð°Ñ‡Ð°Ñ” Ð½Ð°ÑÑ‚ÑƒÐ¿Ð½Ð¸Ð¹ Ð´Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð¼Ð¸Ð¹ Ñ‡Ð°Ñ Ð´Ð»Ñ Ð½Ð°Ð³Ð°Ð´ÑƒÐ²Ð°Ð½Ð½Ñ.
    Ð¯ÐºÑ‰Ð¾ Ñ‡Ð°Ñ Ð¼Ñ–Ð¶ 21:00 Ñ– 09:00, Ð¿ÐµÑ€ÐµÐ½Ð¾ÑÐ¸Ñ‚ÑŒ Ð½Ð° 9:00 Ð½Ð°ÑÑ‚ÑƒÐ¿Ð½Ð¾Ð³Ð¾ Ð´Ð½Ñ.
    """
    if current_time.hour >= 21 or current_time.hour < 9:
        next_day = current_time + timedelta(days=1)
        return next_day.replace(hour=9, minute=0, second=0, microsecond=0)
    return current_time

def generate_follow_up(last_interaction_time: datetime, current_time: datetime, first_name: str) -> tuple[str, datetime]:
    """
    Ð“ÐµÐ½ÐµÑ€ÑƒÑ” Ñ„Ð¾Ð»Ð»Ð¾Ñƒ-Ð°Ð¿ Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ñ– Ñ‡Ð°ÑÑƒ Ð¾ÑÑ‚Ð°Ð½Ð½ÑŒÐ¾Ñ— Ð²Ð·Ð°Ñ”Ð¼Ð¾Ð´Ñ–Ñ—.
    """
    elapsed_time = (current_time - last_interaction_time).total_seconds()

    for interval, message in REMINDER_INTERVALS.items():
        if elapsed_time >= REMINDER_INTERVALS[interval]:
            next_time = get_next_valid_time(current_time)
            return FOLLOW_UP_PROMPTS[interval].format(first_name=first_name), next_time

    return None, None
